<app-navbar></app-navbar>

<div class="max-w-5xl mx-auto bg-brown-200 rounded-2xl px-6 py-10 shadow-xl relative mt-32">

  @if (authService.currentUser.id == profileId) {
  <div class="flex items-start gap-6">
    <div class="relative">
      <img [src]="baseUrl + authService.currentUser.avatarImageUrl" alt="User Avatar"
        class="w-28 h-28 rounded-full border-4 border-brown-700 shadow-xl" />

      <label for="profile-picture"
        class="absolute -top-2 -right-2 w-8 h-8 flex items-center justify-center bg-brown-600 text-white rounded-full shadow-md cursor-pointer hover:bg-brown-700">
        <span class="sr-only">Cambiar imagen</span>
        <i class="fa-solid fa-pen text-sm"></i>
      </label>
      <input id="profile-picture" type="file" class="hidden" accept="image/png, image/jpeg, image/jpg"
        (change)="onFileSelected($event)" />

      <button (click)="deleteAvatar()"
        class="absolute bottom-0 right-0 w-8 h-8 flex items-center justify-center bg-brown-600 text-white rounded-full shadow-md hover:bg-brown-700">
        <span class="sr-only">Eliminar imagen</span>
        <i class="fa-solid fa-xmark text-sm"></i>
      </button>
    </div>

    <div class="flex-1 space-y-2">
      <div class="flex items-center gap-2">
        <h2 class="text-2xl font-bold text-brown-800 truncate">{{ authService.currentUser.userName }}</h2>
        <button (click)="openModal('name')"
          class="text-xs px-2 py-1 bg-brown-600 text-white rounded hover:bg-brown-700">
          <i class="fa-solid fa-pen text-sm"></i>
        </button>
      </div>

      <div class="flex items-center gap-2">
        <p class="text-brown-700 truncate">{{ authService.currentUser.email }}</p>
        <button (click)="openModal('email')"
          class="text-xs px-2 py-1 bg-brown-600 text-white rounded hover:bg-brown-700">
          <i class="fa-solid fa-pen text-sm"></i>
        </button>
      </div>

      <button (click)="openModal('password')"
        class="mt-3 px-4 py-2 bg-brown-700 text-white rounded-md hover:bg-brown-800">
        Cambiar contraseÃ±a
      </button>
    </div>
  </div>

  <div *ngIf="isModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
    <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md space-y-4">
      <h2 class="text-xl font-bold">
        {{ editType === 'name' ? 'Editar Nombre' : editType === 'email' ? 'Editar Correo' : 'Cambiar ContraseÃ±a' }}
      </h2>

      <ng-container *ngIf="editType !== 'password'">
        <input [(ngModel)]="newValue"
          class="border p-2 rounded w-full focus:ring-2 focus:ring-brown-500 outline-none" />
      </ng-container>

      <ng-container *ngIf="editType === 'password'">
        <input type="password" placeholder="Nueva contraseÃ±a" [(ngModel)]="newPassword"
          class="border p-2 rounded w-full" />
        <input type="password" placeholder="Confirmar contraseÃ±a" [(ngModel)]="confirmPassword"
          class="border p-2 rounded w-full" />
        <p *ngIf="passwordError" class="text-red-500 text-sm mt-1">{{ passwordError }}</p>
      </ng-container>

      <div class="flex justify-end gap-2 pt-2">
        <button (click)="closeModal()" class="px-4 py-2 bg-gray-400 text-white rounded hover:bg-gray-500">
          Cancelar
        </button>
        <button (click)="saveChanges()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          Guardar
        </button>
      </div>
    </div>
  </div>
  }

  @else {
  <div class="flex items-center gap-6">
    <img [src]="baseUrl + user.avatarImageUrl" alt="User Avatar"
      class="w-28 h-28 rounded-full border-4 border-brown-700 shadow-xl" />

    <div>
      <h2 class="text-2xl font-bold text-brown-800">{{ user.userName }}</h2>
      <p class="text-brown-700">{{ user.email }}</p>
      <div class="mt-4 space-x-2">
        @if (isFriend) {
        <button (click)="removeFriend(user.id)" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
          Eliminar amigo
        </button>
        } @else {
        <button (click)="addFriend(user.id)" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
          AÃ±adir amigo
        </button>
        }
      </div>
    </div>
  </div>
  }

  <!-- Historial de partidas -->
  <div class="text-brown-900 pt-10">
    <h3 class="text-xl font-bold mb-4 text-brown-800">Historial de partidas</h3>

    <!-- Tabs -->
    <div class="flex mb-6 gap-4">
      <button class="px-4 py-2 rounded-t-lg font-semibold"
        [ngClass]="{'bg-brown-600 text-white': activeTab === GameType.Chess}" (click)="changeTab(GameType.Chess)">
        Ajedrez
      </button>
      <button class="px-4 py-2 rounded-t-lg font-semibold"
        [ngClass]="{'bg-brown-600 text-white': activeTab === GameType.Connect4}" (click)="changeTab(GameType.Connect4)">
        Conecta 4
      </button>
    </div>

    <!-- Filtro de partidas -->
    <div class="mb-4 flex items-center gap-2 text-sm font-medium">
      <select id="gamesPerPage" [(ngModel)]="pageSize" (change)="changePageSize($event)"
        class="border-2 border-brown-600 rounded-md p-1.5 text-brown-800 cursor-pointer focus:ring-2 focus:ring-brown-500">
        <option value="5"> Mostrar 5 partidas</option>
        <option value="10">Mostrar 10 partidas</option>
        <option value="15">Mostrar 15 partidas</option>
        <option value="20">Mostrar 20 partidas</option>
      </select>
    </div>

    <!-- Listado de partidas -->
    <div class="space-y-4">
      @for (game of games.details; track $index) {
      <div class="bg-brown-600 rounded-xl p-4 shadow-inner hover:shadow-lg transition-all duration-300 text-amber-50">
        <p class="text-base font-semibold text-amber-100 mb-2">
          {{ activeTab === GameType.Chess ? 'â™Ÿ Ajedrez' : 'ðŸ”¹ Conecta 4' }}
        </p>

        <div class="flex items-center gap-2 text-brown-100 mb-2">
          <img [src]="baseUrl + game.user.avatarImageUrl" alt="Avatar"
            class="w-9 h-9 rounded-full object-cover border-2 border-amber-200 shadow-sm" />
          <span class="font-semibold truncate max-w-[120px]">{{ game.user.userName }}</span>
          <span class="mx-2 font-bold text-amber-300">VS</span>

          @if (game.opponent == null) {
          <span class="font-semibold">ðŸ¤– Bot</span>
          } @else {
          <img [src]="baseUrl + game.opponent.avatarImageUrl" alt="Avatar"
            class="w-9 h-9 rounded-full object-cover border-2 border-amber-200 shadow-sm" />
          <span class="font-semibold cursor-pointer hover:underline truncate max-w-[120px]"
            (click)="goToProfile(game.opponent.id)">
            {{ game.opponent.userName }}
          </span>
          }
        </div>

        <div class="text-sm text-brown-100">
          <p><span class="font-semibold text-amber-200">Resultado:</span> {{ getResultGame(game.playState) }}</p>
          <p><span class="font-semibold text-amber-200">DuraciÃ³n:</span> {{ game.duration | pipeTimer }}</p>
        </div>
      </div>
      }
    </div>

    <!-- PaginaciÃ³n -->
    <div class="flex justify-center items-center gap-2 mt-6">
      <button (click)="goToFirstPage()" [disabled]="actualPage === 1" title="primera pÃ¡gina"
        class="p-2 rounded-full bg-brown-700 text-white hover:bg-brown-800 disabled:opacity-50">
        <i class="fa-solid fa-angles-left"></i>
      </button>
      <button (click)="prevPage()" [disabled]="actualPage === 1" title="pÃ¡gina anterior"
        class="p-2 rounded-full bg-brown-700 text-white hover:bg-brown-800 disabled:opacity-50">
        <i class="fa-solid fa-chevron-left"></i>
      </button>
      <span class="text-brown-800 font-semibold px-3 text-sm">
        {{ actualPage }} / {{ totalPages }}
      </span>
      <button (click)="nextPage()" [disabled]="actualPage === totalPages || totalPages === 0" title="siguiente pÃ¡gina"
        class="p-2 rounded-full bg-brown-700 text-white hover:bg-brown-800 disabled:opacity-50">
        <i class="fa-solid fa-chevron-right"></i>
      </button>
      <button (click)="goToLastPage()" [disabled]="actualPage === totalPages || totalPages === 0" title="ultima pÃ¡gina"
        class="p-2 rounded-full bg-brown-700 text-white hover:bg-brown-800 disabled:opacity-50">
        <i class="fa-solid fa-angles-right"></i>
      </button>
    </div>
  </div>
</div>